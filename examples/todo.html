<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            color: #222;
            font: 14px Arial;
        }
        body a {
            color: #3D5C9D;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script src="../lib/kagedb.js"></script>
    <script>
        (function () {

            if (typeof KageDB === "undefined") {
                alert("Indexed Database API is not supported in your browser. " +
                        "This example does't work.");
                return;
            }

            var kageDB = new KageDB();
            kageDB.onerror = function (e) {
                console.error(e.target.kage_getErrorMessage());
            };

            function open() {
                var req = kageDB.open("todos", 1);
                req.onupgradeneeded = function (e) {
                    var db = e.target.result;
                    if(db.objectStoreNames.contains("todo")) {
                        db.deleteObjectStore("todo");
                    }
                    db.createObjectStore("todo", {keyPath: "timeStamp"});
                };
                return req;
            }

            function addTodo(todoText, callback) {
                var req = open();
                req.onsuccess = function (e) {
                    var db = e.target.result;
                    var tx = db.transaction(["todo"], IDBTransaction.READ_WRITE);
                    var store = tx.objectStore("todo");

                    var data = {
                        "text": todoText,
                        "timeStamp": new Date().getTime()
                    };

                    var req = store.put(data);
                    req.onsuccess = function(e) {
                        callback();
                    };
                };
            }

            function deleteTodo(id, callback) {
                var req = open();
                req.onsuccess = function (e) {
                    var db = e.target.result;
                    var tx = db.transaction(["todo"], IDBTransaction.READ_WRITE);
                    var store = tx.objectStore("todo");
                    var req = store.delete(id);
                    req.onsuccess = function(e) {
                        callback();
                    };
                };
            }

            function getAllTodoItems(callback) {
                var req = open();
                req.onsuccess = function (e) {
                    var db = e.target.result;
                    var tx = db.transaction(["todo"], IDBTransaction.READ_WRITE);
                    var store = tx.objectStore("todo");

                    // Get everything in the store;
                    var req = store.fetch(IDBKeyRange.lowerBound(0), IDBCursor.NEXT);
                    req.onsuccess = function(e) {
                        callback(e.target.result);
                    };
                };
            }

            function renderTodos(items) {
                var todos = document.getElementById("todoItems");
                todos.innerHTML = "";

                items.forEach(function (item) {
                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    var t = document.createTextNode(item.text);

                    a.addEventListener("click", function() {
                        deleteTodo(item.timeStamp, render);
                    });

                    a.textContent = " [Delete]";
                    li.appendChild(t);
                    li.appendChild(a);
                    todos.appendChild(li)
                });
            }

            function render() {
                getAllTodoItems(renderTodos);
            }

            window.addEventListener("DOMContentLoaded", function () {
                render();

                var add = document.getElementById("add");
                add.addEventListener('click', function (e) {
                    var todo = document.getElementById("todo");
                    if (todo.value !== "") {
                        addTodo(todo.value, render);
                    }
                    todo.value = "";
                });
            });
        }());
    </script>
</head>
<body>
<input type="text" id="todo" name="todo" placeholder="What do you need to do?" style="width: 200px;" />
<input type="button" id="add" value="Add Todo Item"/>
<ul id="todoItems"></ul>
</body>
</html>â€‹